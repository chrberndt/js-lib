<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="js/leaflet-1.0.0-rc1/leaflet.css" />
  <style>
    .map {
      height: 70vh;
    }
  </style>
</head>

<body>

  <div id="map" class="map">
  </div>
  <form id="fm">
    <label for="geoJSON">GeoJSON: </label>
    <textarea id="geoJSON"></textarea>
  </form>

  <script src="js/leaflet-1.0.0-rc1/leaflet.js"></script>

  <script src="js/Leaflet.Editable.js"></script>
  <script>
    var tilesAttribution = '&copy; <a href="http://osm.org/copyright" target="_blank">OpenStreetMap</a> contributors';

    var tilesURL = "http://{s}.tile.osm.org/{z}/{x}/{y}.png";


    var zoom = 16;
    if (getCookie('zoom') != "") {
      zoom = getCookie('zoom');
    }

    var center = [52.51733, 13.38886];
    if (getCookie('center') != "") {
      center = JSON.parse(getCookie('center'));
    }

    var map = L.map('map', {
        editable: true
      }).setView(center, zoom)
      , tilelayer = L.tileLayer(tilesURL, {
        maxZoom: 20
        , attribution: tilesAttribution
      }).addTo(map);

    L.NewLineControl = L.Control.extend({

      options: {
        position: 'topleft'
      },

      onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar')
          , link = L.DomUtil.create('a', '', container);

        link.href = '#';
        link.title = 'Create a new line';
        link.innerHTML = '/\\/';
        L.DomEvent.on(link, 'click', L.DomEvent.stop)
          .on(link, 'click', function () {
            map.editTools.startPolyline();
          });

        return container;
      }
    });

    L.NewPolygonControl = L.Control.extend({

      options: {
        position: 'topleft'
      },

      onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar')
          , link = L.DomUtil.create('a', '', container);

        link.href = '#';
        link.title = 'Create a new polygon';
        link.innerHTML = '▱';
        L.DomEvent.on(link, 'click', L.DomEvent.stop)
          .on(link, 'click', function () {
            map.editTools.startPolygon();
          });

        return container;
      }
    });

    L.NewMarkerControl = L.Control.extend({

      options: {
        position: 'topleft'
      },

      onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar')
          , link = L.DomUtil.create('a', '', container);

        link.href = '#';
        link.title = 'Add a new marker';
        link.innerHTML = '⚫';
        L.DomEvent.on(link, 'click', L.DomEvent.stop)
          .on(link, 'click', function () {
            map.editTools.startMarker({
              title: "foo"
            });
          });

        return container;
      }
    });

    map.addControl(new L.NewMarkerControl());
    // map.addControl(new L.NewLineControl());
    map.addControl(new L.NewPolygonControl());


    function getCookie(cname) {

      var name = cname + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    function setCookie(cname, cvalue, exdays) {

      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + "; " + expires;

    }

    var clearGeoJSON = function (e) {
      document.getElementById('geoJSON').value = "";
    }

    var clearLayers = function (e) {
      map.eachLayer(function (layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
        if (layer instanceof L.Path) {
          map.removeLayer(layer);
        }
      })
    };

    var deleteMarker = function (e) {
      if ((e.originalEvent.ctrlKey || e.originalEvent.metaKey)) {
        map.removeLayer(this);
      }
    };

    var deleteShape = function (e) {
      if ((e.originalEvent.ctrlKey || e.originalEvent.metaKey) && this.editEnabled()) {
        this.editor.deleteShapeAt(e.latlng);
      }
    };

    var updateCoordinates = function (e) {

      var geoJSON = "";

      if (e.layer instanceof L.Marker) {
        geoJSON = e.layer.toGeoJSON();
      }
      if (e.layer instanceof L.Path) {
        geoJSON = e.layer.toGeoJSON();
      }

      document.getElementById('geoJSON').value = JSON.stringify(geoJSON);
    }

    map.on('editable:drawing:end', updateCoordinates);
    map.on('editable:drawing:start', clearGeoJSON);
    map.on('editable:drawing:start', clearLayers);

    map.on('layeradd', function (e) {
      if (e.layer instanceof L.Marker) {
        e.layer.on('click', L.DomEvent.stop).on('click', deleteMarker, e.layer);
      }
      if (e.layer instanceof L.Path) {
        e.layer.on('click', L.DomEvent.stop).on('click', deleteShape, e.layer);
      }
      if (e.layer instanceof L.Path) e.layer.on('dblclick', L.DomEvent.stop).on('dblclick', e.layer.toggleEdit);
    });

    map.on('zoomend', function (e) {
      // console.log(map.getZoom());
      setCookie('zoom', map.getZoom(), 365);
    });

    map.on('dragend', function (e) {
      setCookie('center', JSON.stringify(map.getCenter()), 365);
    })

    setTimeout(function () {
      map.invalidateSize();
    }, 1000);
  </script>
</body>

</html>